-- üçé Loop Collect + Sell Fruits System
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local player = Players.LocalPlayer

-- üå≥ Remotes
local FruitRemote = ReplicatedStorage
    :WaitForChild("Framework")
    :WaitForChild("Features")
    :WaitForChild("FruitTreeSystem")
    :WaitForChild("TreeStumpUtil")
    :WaitForChild("RemoteEvent")

local SellRemote = ReplicatedStorage
    :WaitForChild("Framework")
    :WaitForChild("Features")
    :WaitForChild("FruitStallSystem")
    :WaitForChild("FruitStallUtil")
    :WaitForChild("RemoteEvent")

-- üé® Colors
local PRIMARY = Color3.fromRGB(255, 0, 0)
local ACTIVE = Color3.fromRGB(60, 200, 90)

-- üß© Helper: find the player's plot
local function getPlayerPlot()
	for _, plot in ipairs(workspace:WaitForChild("PlayerPlots"):GetChildren()) do
		local owner = plot:FindFirstChild("Owner")
		if owner and owner.Value == player then
			return plot
		end
	end
end

-- üçé Core collector logic
local function collectAllFruits()
	local total = 0
	pcall(function()
		local plot = getPlayerPlot()
		if not plot then return end

		local trees = plot:FindFirstChild("Trees")
		if not trees then return end

		for _, tree in ipairs(trees:GetChildren()) do
			for _, stump in ipairs(tree:GetChildren()) do
				for _, item in ipairs(stump:GetChildren()) do
					if item:IsA("Folder") or item:IsA("Model") then
						for _, obj in ipairs(item:GetDescendants()) do
							if obj.Name:match("_Fruit%d+") or obj.Name:match("Fruit%d+") then
								local fruitName = obj.Name:match("Fruit%d+")
								for a2 = 1, 2 do
									for a3 = 1, 2 do
										for a4 = 1, 2 do
											pcall(function()
												local args = {
													"PickFruit",
													a2,
													a3,
													a4,
													fruitName
												}
												FruitRemote:FireServer(unpack(args))
												total += 1
											end)
											task.wait(0.03)
										end
									end
								end
							end
						end
					end
				end
			end
		end
	end)
	return total
end

-- üîò Create Loop Collect Button
local LoopButton = Instance.new("TextButton")
LoopButton.Parent = MainTab
LoopButton.Size = UDim2.new(0,220,0,40)
LoopButton.Position = UDim2.new(0,20,0,70)
LoopButton.BackgroundColor3 = PRIMARY
LoopButton.TextColor3 = Color3.fromRGB(255,255,255)
LoopButton.Text = "Loop Collect Fruits: OFF"
CreateRounded(LoopButton,8)

local collecting = false
local collectThread

-- üß† Button toggle logic
LoopButton.MouseButton1Click:Connect(function()
	collecting = not collecting
	LoopButton.Text = "Loop Collect Fruits: " .. (collecting and "ON" or "OFF")
	LoopButton.BackgroundColor3 = collecting and ACTIVE or PRIMARY

	if collecting then
		collectThread = task.spawn(function()
			while collecting do
				local total = collectAllFruits()
				print("‚úÖ Collected fruits this cycle:", total)
				task.wait(0.8)
			end
		end)
	else
		if collectThread then
			task.cancel(collectThread)
		end
	end
end)

-- üí∞ Sell Fruits Button
local SellButton = Instance.new("TextButton")
SellButton.Parent = MainTab
SellButton.Size = UDim2.new(0,220,0,40)
SellButton.Position = UDim2.new(0,20,0,120)
SellButton.BackgroundColor3 = PRIMARY
SellButton.TextColor3 = Color3.fromRGB(255,255,255)
SellButton.Text = "Sell Fruits"
CreateRounded(SellButton,8)

SellButton.MouseButton1Click:Connect(function()
	pcall(function()
		local args = { "RequestGiveFruits" }
		SellRemote:FireServer(unpack(args))
		print("üí∏ Sold all fruits!")
	end)
end)
