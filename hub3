-- Clean Hub with Mining, Wheel, Rewards, Teleport, Eggs, Auto-Win, Emergency, Auto-Delete, Auto-Collect, World/Magnet
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local VirtualUser = game:GetService("VirtualUser")

local player = Players.LocalPlayer
local guiParent = CoreGui

-- Remotes
local GameHandler = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("GameHandler")
local WheelRemote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("Wheel")
local PlaytimeRemote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("Playtime")
local EggsRemote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("Eggs")
local PetsRemote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("Pets")

-- Sizes
local CLOSED_SZ = UDim2.new(0,1,0,1)
local HUB_SZ = UDim2.new(0,700,0,450)
local MINIMIZED_SZ = UDim2.new(0,200,0,40)

-- Tween helper
local tweenInfo = TweenInfo.new(0.5, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
local function tween(obj, props)
    local tw = TweenService:Create(obj, tweenInfo, props)
    tw:Play()
    return tw
end

local function round(ui, radius)
    local c = Instance.new("UICorner", ui)
    c.CornerRadius = UDim.new(0, radius or 8)
end

-- ScreenGui
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "CleanHubGui"
screenGui.ResetOnSpawn = false
screenGui.Parent = guiParent

-- Main Frame
local frame = Instance.new("Frame", screenGui)
frame.Name = "MainFrame"
frame.Size = HUB_SZ
frame.Position = UDim2.new(0.5,0,0.5,0)
frame.AnchorPoint = Vector2.new(0.5,0.5)
frame.BackgroundColor3 = Color3.fromRGB(20,20,20)
frame.Active = true
frame.BorderSizePixel = 0
round(frame,10)

-- Dragging
local dragging, dragInput, dragStart, startPos
UserInputService.InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        local delta = input.Position - dragStart
        frame.Position = UDim2.new(
            startPos.X.Scale, startPos.X.Offset+delta.X,
            startPos.Y.Scale, startPos.Y.Offset+delta.Y
        )
    end
end)

local function enableDrag(target)
    target.InputBegan:Connect(function(i)
        if i.UserInputType==Enum.UserInputType.MouseButton1 or i.UserInputType==Enum.UserInputType.Touch then
            dragging = true
            dragStart = i.Position
            startPos = frame.Position
            i.Changed:Connect(function()
                if i.UserInputState==Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    target.InputChanged:Connect(function(i)
        if i.UserInputType==Enum.UserInputType.MouseMovement or i.UserInputType==Enum.UserInputType.Touch then
            dragInput = i
        end
    end)
end

-- Top Bar
local bar=Instance.new("Frame",frame)
bar.Size=UDim2.new(1,0,0,40)
bar.Position=UDim2.new(0,0,0,0)
bar.BackgroundColor3=Color3.fromRGB(40,40,40)
bar.Active=true
round(bar,10)
enableDrag(bar)

local title=Instance.new("TextLabel",bar)
title.Size=UDim2.new(1,-120,1,0)
title.Position = UDim2.new(0,10,0,0)
title.BackgroundTransparency=1
title.Font=Enum.Font.SourceSansBold
title.TextSize=24
title.Text="Clean Hub"
title.TextColor3=Color3.new(1,1,1)
title.TextXAlignment=Enum.TextXAlignment.Left

local closeBtn=Instance.new("TextButton",bar)
closeBtn.Size=UDim2.new(0,30,0,30)
closeBtn.Position=UDim2.new(1,-40,0,5)
closeBtn.Text="X"
closeBtn.Font=Enum.Font.SourceSansBold
closeBtn.TextSize=18
closeBtn.BackgroundColor3=Color3.fromRGB(200,50,50)
closeBtn.TextColor3=Color3.new(1,1,1)
round(closeBtn,4)

local minBtn=Instance.new("TextButton",bar)
minBtn.Size=UDim2.new(0,30,0,30)
minBtn.Position=UDim2.new(1,-80,0,5)
minBtn.Text="-"
minBtn.Font=Enum.Font.SourceSansBold
minBtn.TextSize=22
minBtn.BackgroundColor3=Color3.fromRGB(100,100,100)
minBtn.TextColor3=Color3.new(1,1,1)
round(minBtn,4)

-- Tabs + Content
local tabsFrame=Instance.new("Frame",frame)
tabsFrame.Size=UDim2.new(0,140,1,-60)
tabsFrame.Position=UDim2.new(0,0,0,50)
tabsFrame.BackgroundTransparency=1

local contentFrame=Instance.new("Frame",frame)
contentFrame.Size=UDim2.new(1,-140,1,-60)
contentFrame.Position=UDim2.new(0,140,0,50)
contentFrame.BackgroundTransparency=1
enableDrag(contentFrame)

-- Tab Names
local tabNames={"Mine","Wheel","Rewards","Teleport","Eggs","Auto-Win","Emergency","Auto-Delete","Auto-Collect","World/Magnet"}

local tabButtons={}

-- Global state
local mining = false
local spinning = false
local autoWin = false
local eggButtons = {}
local rewardButtons = {}
local autoDelete = false
local targetPetType = ""
local autoCollecting = false

-- ================= Mine Tab =================
local function buildMineTab()
    for _,v in pairs(contentFrame:GetChildren()) do v:Destroy() end
    local label = Instance.new("TextLabel", contentFrame)
    label.Size = UDim2.new(0.6,-10,0,30)
    label.Position = UDim2.new(0,10,0,10)
    label.BackgroundTransparency = 1
    label.Text = "Auto-Mine"
    label.TextColor3 = Color3.new(1,1,1)
    label.Font = Enum.Font.SourceSansBold
    label.TextSize = 18
    label.TextXAlignment = Enum.TextXAlignment.Left

    local mineBtn = Instance.new("TextButton", contentFrame)
    mineBtn.Size = UDim2.new(0.35,0,0,30)
    mineBtn.Position = UDim2.new(0.65,0,0,10)
    mineBtn.Text = "OFF"
    mineBtn.Font = Enum.Font.SourceSansBold
    mineBtn.TextSize = 18
    mineBtn.BackgroundColor3 = Color3.fromRGB(88,101,242)
    mineBtn.TextColor3 = Color3.new(1,1,1)
    round(mineBtn,6)

    local mineArgs = {{Info="Mine"}}
    local interval = 0.1

    local function startMining()
        while mining do
            pcall(function() GameHandler:FireServer(unpack(mineArgs)) end)
            task.wait(interval)
        end
    end

    mineBtn.MouseButton1Click:Connect(function()
        mining = not mining
        mineBtn.Text = mining and "ON" or "OFF"
        mineBtn.BackgroundColor3 = mining and Color3.fromRGB(0,170,0) or Color3.fromRGB(88,101,242)
        if mining then task.spawn(startMining) end
    end)
end

-- ================= Wheel Tab =================
local function buildWheelTab()
    for _,v in pairs(contentFrame:GetChildren()) do v:Destroy() end
    local label = Instance.new("TextLabel", contentFrame)
    label.Size = UDim2.new(0.6,-10,0,30)
    label.Position = UDim2.new(0,10,0,10)
    label.BackgroundTransparency = 1
    label.Text = "Auto-Spin Wheel"
    label.TextColor3 = Color3.new(1,1,1)
    label.Font = Enum.Font.SourceSansBold
    label.TextSize = 18
    label.TextXAlignment = Enum.TextXAlignment.Left

    local wheelBtn = Instance.new("TextButton", contentFrame)
    wheelBtn.Size = UDim2.new(0.35,0,0,30)
    wheelBtn.Position = UDim2.new(0.65,0,0,10)
    wheelBtn.Text = "OFF"
    wheelBtn.Font = Enum.Font.SourceSansBold
    wheelBtn.TextSize = 18
    wheelBtn.BackgroundColor3 = Color3.fromRGB(88,101,242)
    wheelBtn.TextColor3 = Color3.new(1,1,1)
    round(wheelBtn,6)

    wheelBtn.MouseButton1Click:Connect(function()
        spinning = not spinning
        wheelBtn.Text = spinning and "ON" or "OFF"
        wheelBtn.BackgroundColor3 = spinning and Color3.fromRGB(0,170,0) or Color3.fromRGB(88,101,242)
        if spinning then
            task.spawn(function()
                while spinning do
                    pcall(function() WheelRemote:InvokeServer() end)
                    task.wait(0.5)
                end
            end)
        end
    end)
end

-- ================= Rewards Tab =================
local function buildRewardsTab()
    for _,v in pairs(contentFrame:GetChildren()) do v:Destroy() end
    local label = Instance.new("TextLabel", contentFrame)
    label.Size = UDim2.new(0.6,-10,0,30)
    label.Position = UDim2.new(0,10,0,10)
    label.BackgroundTransparency = 1
    label.Text = "Auto-Collect Rewards"
    label.TextColor3 = Color3.new(1,1,1)
    label.Font = Enum.Font.SourceSansBold
    label.TextSize = 18
    label.TextXAlignment = Enum.TextXAlignment.Left

    local scrollFrame = Instance.new("ScrollingFrame", contentFrame)
    scrollFrame.Size = UDim2.new(1,-20,1,-50)
    scrollFrame.Position = UDim2.new(0,10,0,50)
    scrollFrame.CanvasSize = UDim2.new(0,0,0,0)
    scrollFrame.ScrollBarThickness = 10
    scrollFrame.BackgroundTransparency = 0.8
    scrollFrame.BackgroundColor3 = Color3.fromRGB(30,30,30)
    round(scrollFrame, 8)
    local uiList = Instance.new("UIListLayout", scrollFrame)
    uiList.SortOrder = Enum.SortOrder.LayoutOrder
    uiList.Padding = UDim.new(0,5)

    rewardButtons = {} -- reset
    for i=1,9 do
        local btn = Instance.new("TextButton", scrollFrame)
        btn.Size = UDim2.new(1,0,0,30)
        btn.Text = "OFF - Reward "..i
        btn.Font = Enum.Font.SourceSansBold
        btn.TextSize = 16
        btn.TextColor3 = Color3.new(1,1,1)
        btn.BackgroundColor3 = Color3.fromRGB(88,101,242)
        round(btn,6)

        local collecting = false
        btn.MouseButton1Click:Connect(function()
            collecting = not collecting
            btn.Text = (collecting and "ON - " or "OFF - ").."Reward "..i
            btn.BackgroundColor3 = collecting and Color3.fromRGB(0,170,0) or Color3.fromRGB(88,101,242)

            if collecting then
                task.spawn(function()
                    while collecting do
                        local args = {{Info="ClaimReward", Reward=i}}
                        pcall(function() PlaytimeRemote:FireServer(unpack(args)) end)
                        task.wait(0.2)
                    end
                end)
            end
        end)
        table.insert(rewardButtons, btn)
    end
    scrollFrame.CanvasSize = UDim2.new(0,0,0,uiList.AbsoluteContentSize.Y + 10)
end

-- ================= Teleport Tab =================
local function buildTeleportTab()
    for _,v in pairs(contentFrame:GetChildren()) do v:Destroy() end
    local label = Instance.new("TextLabel", contentFrame)
    label.Size = UDim2.new(0.6,-10,0,30)
    label.Position = UDim2.new(0,10,0,10)
    label.BackgroundTransparency = 1
    label.Text = "Teleport Worlds"
    label.TextColor3 = Color3.new(1,1,1)
    label.Font = Enum.Font.SourceSansBold
    label.TextSize = 18
    label.TextXAlignment = Enum.TextXAlignment.Left
end

-- ================= Eggs Tab =================
local function buildEggTab()
    for _,v in pairs(contentFrame:GetChildren()) do v:Destroy() end
    local label = Instance.new("TextLabel", contentFrame)
    label.Size = UDim2.new(0.6,-10,0,30)
    label.Position = UDim2.new(0,10,0,10)
    label.BackgroundTransparency = 1
    label.Text = "Auto-Open Eggs"
    label.TextColor3 = Color3.new(1,1,1)
    label.Font = Enum.Font.SourceSansBold
    label.TextSize = 18
    label.TextXAlignment = Enum.TextXAlignment.Left
end

-- ================= Auto-Win Tab =================
local function buildAutoWinTab()
    for _,v in pairs(contentFrame:GetChildren()) do v:Destroy() end
    local label = Instance.new("TextLabel", contentFrame)
    label.Size = UDim2.new(0.6,-10,0,30)
    label.Position = UDim2.new(0,10,0,10)
    label.BackgroundTransparency = 1
    label.Text = "Auto Win Toggle"
    label.TextColor3 = Color3.new(1,1,1)
    label.Font = Enum.Font.SourceSansBold
    label.TextSize = 18
    label.TextXAlignment = Enum.TextXAlignment.Left
end

-- ================= Emergency Tab =================
local function buildEmergencyTab()
    for _,v in pairs(contentFrame:GetChildren()) do v:Destroy() end
end

-- ================= Auto-Delete Tab =================
local function buildAutoDeleteTab()
    for _,v in pairs(contentFrame:GetChildren()) do v:Destroy() end
end

-- ================= Auto-Collect Tab =================
local function buildAutoCollectTab()
    for _,v in pairs(contentFrame:GetChildren()) do v:Destroy() end
end

-- ================= World/Magnet Tab =================
local autoSwitch = false
local magnetCollecting = false
local worlds = {4,5}
local cooldown = 6
local maxWaitForRespawn = 12
local magnetRange = 5

local function safeGetItemsFolder()
    local ok, folder = pcall(function()
        local g = workspace:FindFirstChild("Game")
        if not g then return nil end
        return g:FindFirstChild("MapItems")
    end)
    return ok and folder or nil
end

local function switchWorld(worldId)
    local ok, err = pcall(function()
        local args = {{Info="SwitchWorld", World=worldId}}
        GameHandler:FireServer(unpack(args))
    end)
    if not ok then warn(err) end
end

local function startAutoSwitch()
    if autoSwitch then return end
    autoSwitch = true
    task.spawn(function()
        local index = 1
        while autoSwitch do
            local itemsFolder = safeGetItemsFolder()
            local beforeCount = (itemsFolder and #itemsFolder:GetChildren()) or 0
            switchWorld(worlds[index])
            local t0 = tick()
            local respawned = false
            while tick()-t0 < maxWaitForRespawn and autoSwitch do
                local newFolder = safeGetItemsFolder()
                local newCount = (newFolder and #newFolder:GetChildren()) or 0
                if newCount ~= beforeCount and newCount > 0 then
                    respawned = true
                    break
                end
                task.wait(0.25)
            end
            if not respawned then task.wait(cooldown) end
            index = (index % #worlds) + 1
        end
    end)
end

local function stopAutoSwitch()
    autoSwitch = false
end

local function startMagnet()
    if magnetCollecting then return end
    magnetCollecting = true
    task.spawn(function()
        local character = player.Character or player.CharacterAdded:Wait()
        local hrp = character:WaitForChild("HumanoidRootPart")
        while magnetCollecting do
            local itemsFolder = safeGetItemsFolder()
            if itemsFolder then
                for _, item in ipairs(itemsFolder:GetChildren()) do
                    local basePart = item.PrimaryPart or item:FindFirstChildWhichIsA("BasePart")
                    if basePart then
                        pcall(function()
                            basePart.CFrame = hrp.CFrame * CFrame.new(0,0,-magnetRange)
                        end)
                    end
                end
            end
            task.wait(0.1)
        end
    end)
end

local function stopMagnet()
    magnetCollecting = false
end

local function buildWorldMagnetTab()
    for _,v in pairs(contentFrame:GetChildren()) do v:Destroy() end

    local label = Instance.new("TextLabel", contentFrame)
    label.Size = UDim2.new(0.6,-10,0,30)
    label.Position = UDim2.new(0,10,0,10)
    label.BackgroundTransparency = 1
    label.Text = "World / Magnet Settings"
    label.TextColor3 = Color3.new(1,1,1)
    label.Font = Enum.Font.SourceSansBold
    label.TextSize = 18
    label.TextXAlignment = Enum.TextXAlignment.Left

    local worldBtn = Instance.new("TextButton", contentFrame)
    worldBtn.Size = UDim2.new(0.35,0,0,30)
    worldBtn.Position = UDim2.new(0.65,0,0,10)
    worldBtn.Text = "Auto World Switcher: OFF"
    worldBtn.Font = Enum.Font.SourceSansBold
    worldBtn.TextSize = 16
    worldBtn.BackgroundColor3 = Color3.fromRGB(88,101,242)
    worldBtn.TextColor3 = Color3.new(1,1,1)
    round(worldBtn,6)
    worldBtn.MouseButton1Click:Connect(function()
        if autoSwitch then
            stopAutoSwitch()
            worldBtn.Text = "Auto World Switcher: OFF"
        else
            startAutoSwitch()
            worldBtn.Text = "Auto World Switcher: ON"
        end
    end)

    local magnetBtn = Instance.new("TextButton", contentFrame)
    magnetBtn.Size = UDim2.new(0.35,0,0,30)
    magnetBtn.Position = UDim2.new(0.65,0,0,50)
    magnetBtn.Text = "Magnet Auto-Collect: OFF"
    magnetBtn.Font = Enum.Font.SourceSansBold
    magnetBtn.TextSize = 16
    magnetBtn.BackgroundColor3 = Color3.fromRGB(88,101,242)
    magnetBtn.TextColor3 = Color3.new(1,1,1)
    round(magnetBtn,6)
    magnetBtn.MouseButton1Click:Connect(function()
        if magnetCollecting then
            stopMagnet()
            magnetBtn.Text = "Magnet Auto-Collect: OFF"
        else
            startMagnet()
            magnetBtn.Text = "Magnet Auto-Collect: ON"
        end
    end)
end

-- ================= Tabs Setup =================
local buildFunctions = {
    buildMineTab,
    buildWheelTab,
    buildRewardsTab,
    buildTeleportTab,
    buildEggTab,
    buildAutoWinTab,
    buildEmergencyTab,
    buildAutoDeleteTab,
    buildAutoCollectTab,
    buildWorldMagnetTab
}

-- Build tab buttons
for i,name in ipairs(tabNames) do
    local btn = Instance.new("TextButton", tabsFrame)
    btn.Size = UDim2.new(1,0,0,40)
    btn.Position = UDim2.new(0,0,(i-1)*45,0)
    btn.Text = name
    btn.Font = Enum.Font.SourceSansBold
    btn.TextSize = 18
    btn.TextColor3 = Color3.new(1,1,1)
    btn.BackgroundColor3 = Color3.fromRGB(50,50,50)
    round(btn,6)

    -- Properly capture index
    btn.MouseButton1Click:Connect((function(idx)
        return function()
            buildFunctions[idx]()
        end
    end)(i))

    table.insert(tabButtons, btn)
end


-- Buttons
closeBtn.MouseButton1Click:Connect(function() frame.Visible=false end)
minBtn.MouseButton1Click:Connect(function() frame.Size = frame.Size==HUB_SZ and MINIMIZED_SZ or HUB_SZ end)

-- Load first tab
buildFunctions[1]()
